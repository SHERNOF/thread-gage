import eel
import pandas as pd
import xlwings as xl


# file_path = r"/Volumes/DDrive/Python-Projects/thread-gage/Tex At Site Thread Gage Worksheet.xlsm"
file_path = r"C:\Tex Onsite\Tex_reff\shernof\thread-gage\Parameters.xlsx"
dfm = pd.read_excel(file_path, sheet_name="metric", engine="openpyxl" )
dfi = pd.read_excel(file_path, sheet_name="imperial", engine="openpyxl" )
# mm = wb.sheets
eel.init('GUI')


# AS1014 and AS1721
def float_range(start, stop, step):  
  while start < stop:
      yield round(start, 1)
      start += step

def float_range_imp(start, stop, step):  
  while start < stop:
      yield round(start, 0.1)
      start += step


"""
From Table 4.6 of AS1014 Deviations for Go Screw Plug Gauges
"""
      
deviation_table = [
        [range(24, 51),{'du':3,'dl':-3}, {'worn':-8},{'mu':6},{'ml':-6}],
        [range(51, 81),{'du':6},{'dl':-1}, {'worn':-7},{'mu':9},{'ml':-5}],
        [range(81, 126),{'du':11},{'dl':2}, {'worn':-6},{'mu':15},{'ml':-3}],
        [range(126, 201),{'du':18},{'dl':6}, {'worn':-5},{'mu':23},{'ml':1}],
        [range(201, 316),{'du':23},{'dl':9}, {'worn':-5},{'mu':30},{'ml':2}],
        [range(316, 501),{'du':33},{'dl':15}, {'worn':-3},{'mu':42},{'ml':6}],
        [range(501, 671),{'du':43},{'dl':21}, {'worn':-1},{'mu':54},{'ml':10}],
        ]
        
        
"""
From Table 4.7 of AS1014 Deviations for No-Go Screw Plug Gauges
"""
deviation_table_nogo = [
        [range(24, 51),{'du':6},{'dl':0}, {'worn':-3},{'mu':9},{'ml':-3}],
        [range(51, 81),{'du':7},{'dl':0}, {'worn':-4},{'mu':10},{'ml':-4}],
        [range(81, 126),{'du':9},{'dl':0}, {'worn':-5},{'mu':13},{'ml':-5}],
        [range(126, 201),{'du':11},{'dl':0}, {'worn':-6},{'mu':16},{'ml':-6}],
        [range(201, 316),{'du':14},{'dl':0}, {'worn':-8},{'mu':21},{'ml':-7}],
        [range(316, 501),{'du':18},{'dl':0}, {'worn':-10},{'mu':27},{'ml':-9}],
        [range(501, 671),{'du':22},{'dl':0}, {'worn':-12},{'mu':33},{'ml':-11}],
        ]

"""
From Table 4.2 of AS1721 Pitch Diamaeter Tolerance for Internal Threads
"""
tolerance_table = [
        [float_range(0.99,1.41,0.01),(0.2),{'4':40,'5':'','6':'','7':'','8':''}],
        [float_range(0.99,1.41,0.01),(0.25),{'4':45,'5':56,'6':'','7':'','8':''}],
        [float_range(0.99,1.41,0.01),(0.3),{'4':48,'5':60,'6':75,'7':'','8':''}],
        
        [float_range(1.41,2.81,0.1),(0.2),{'4':42,'5':'','6':'','7':'','8':''}],
        [float_range(1.41,2.81,0.1),(0.25),{'4':48,'5':60,'6':'','7':'','8':''}],
        [float_range(1.41,2.81,0.1),(0.35),{'4':53,'5':67,'6':85,'7':'','8':''}],
        [float_range(1.41,2.81,0.1),(0.4),{'4':56,'5':71,'6':90,'7':'','8':''}],
        [float_range(1.41,2.81,0.1),(0.45),{'4':60,'5':75,'6':95,'7':'','8':''}],
        
        [float_range(2.81,5.61,0.1),(0.35),{'4':56,'5':71,'6':90,'7':'','8':''}],
        [float_range(2.81,5.61,0.1),(0.5),{'4':63,'5':80,'6':100,'7':125,'8':''}],
        [float_range(2.81,5.61,0.1),(0.6),{'4':71,'5':90,'6':112,'7':140,'8':''}],
        [float_range(2.81,5.61,0.1),(0.7),{'4':75,'5':95,'6':118,'7':150,'8':''}],
        [float_range(2.81,5.61,0.1),(0.75),{'4':75,'5':95,'6':118,'7':150,'8':''}],
        [float_range(2.81,5.61,0.1),(0.8),{'4':80,'5':100,'6':125,'7':160,'8':200}],
        
        [float_range(5.61,11.21,0.1),(0.75),{'4':85,'5':106,'6':132,'7':170,'8':''}],
        [float_range(5.61,11.21,0.1),(1),{'4':95,'5':118,'6':150,'7':190,'8':236}],
        [float_range(5.61,11.21,0.1),(1.25),{'4':100,'5':125,'6':160,'7':200,'8':250}],
        [float_range(5.61,11.21,0.1),(1.5),{'4':112,'5':140,'6':180,'7':224,'8':280}],
        
        [float_range(11.21,22.41,0.1),(1),{'4':100,'5':125,'6':160,'7':200,'8':250}],
        [float_range(11.21,22.41,0.1),(1.25),{'4':112,'5':140,'6':180,'7':224,'8':280}],
        [float_range(11.21,22.41,0.1),(1.5),{'4':118,'5':150,'6':190,'7':236,'8':300}],
        [float_range(11.21,22.41,0.1),(1.75),{'4':125,'5':160,'6':200,'7':250,'8':315}],
        [float_range(11.21,22.41,0.1),(2),{'4':132,'5':170,'6':212,'7':265,'8':335}],
        [float_range(11.21,22.41,0.1),(2.5),{'4':140,'5':180,'6':224,'7':280,'8':355}],
        
        [float_range(22.41,46,0.1),(1),{'4':106,'5':132,'6':170,'7':212,'8':''}],
        [float_range(22.41,46,0.1),(1.5),{'4':125,'5':160,'6':200,'7':250,'8':315}],
        [float_range(22.41,46,0.1),(2),{'4':140,'5':180,'6':224,'7':280,'8':355}],
        [float_range(22.41,46,0.1),(3),{'4':170,'5':212,'6':265,'7':335,'8':425}],
        [float_range(22.41,46,0.1),(3.5),{'4':180,'5':224,'6':280,'7':355,'8':460}],
        [float_range(22.41,46,0.1),(4),{'4':190,'5':236,'6':300,'7':375,'8':475}],
        [float_range(22.41,46,0.1),(4.5),{'4':200,'5':250,'6':315,'7':400,'8':500}],
        
        [range(46,91),(1.5),{'4':132,'5':170,'6':212,'7':265,'8':335}],
        [range(46,91),(2),{'4':150,'5':191,'6':236,'7':300,'8':375}],
        [range(46,91),(3),{'4':180,'5':224,'6':280,'7':355,'8':460}],
        [range(46,91),(4),{'4':200,'5':250,'6':315,'7':400,'8':500}],
        [range(46,91),(5),{'4':212,'5':265,'6':335,'7':425,'8':530}],
        [range(46,91),(5.5),{'4':224,'5':280,'6':355,'7':460,'8':560}],
        [range(46,91),(6),{'4':236,'5':300,'6':375,'7':475,'8':600}],
        
        [range(91,181),(2),{'4':160,'5':200,'6':250,'7':315,'8':400}],
        [range(91,181),(3),{'4':190,'5':236,'6':300,'7':375,'8':475}],
        [range(91,181),(4),{'4':212,'5':265,'6':335,'7':425,'8':530}],                                                   
        [range(91,181),(6),{'4':250,'5':315,'6':400,'7':500,'8':630}],
        
        [range(181,356),(3),{'4':212,'5':265,'6':335,'7':425,'8':530}],
        [range(181,356),(4),{'4':236,'5':300,'6':375,'7':475,'8':600}],
        [range(181,356),(6),{'4':265,'5':355,'6':425,'7':530,'8':670}],                                           
        ]

"""
from table 6 of ASME B1.2-1983
X Gage Tolerance for Thread Gages
"""

imperial_tolerance_major_minorD = [
    [float_range(0.0001,4,0.0001),{80:0.0003,72:0.0003,64:0.0004,56:0.0004,48:0.0004,44:0.0004,40:0.0004,36:0.0004,32:0.0005,28:0.0005,24:0.0005,20:0.0005,18:0.0005,16:0.0006,14:0.0006,13:0.0006,12:0.0006,11.5:0.0006,11:0.0006,10:0.0006,9:0.0007,8:0.0007,7:0.0007,6:0.0008,5:0.0008,4.5:0.0008,4:0.0009}],
    [float_range(4,100,0.0001),{80:0.0000,72:0.0000,64:0.0000,56:0.0000,48:0.0000,44:0.0000,40:0.0000,36:0.0000,32:0.0007,28:0.0007,24:0.0007,20:0.0007,18:0.0007,16:0.0009,14:0.0009,13:0.0009,12:0.0009,11.5:0.0009,11:0.0009,10:0.0009,9:0.0011,8:0.0011,7:0.0011,6:0.0013,5:0.0013,4.5:0.0013,4:0.0015}],
]

"""
from table 6 of ASME B1.2-1983
X Gage Tolerance for Thread Gages
"""
imperial_tolerance_pitch_diameter = [
    [float_range(0.0000,1.5001,0.0001),{80:0.0002,72:0.0002,64:0.0002,56:0.0002,48:0.0002,44:0.0002,40:0.0002,36:0.0002,32:0.0003,28:0.0003,24:0.0003,20:0.0003,18:0.0003,16:0.0003,14:0.0003,13:0.0003,12:0.0003,11.5:0.0003,11:0.0003,10:0.0003,9:0.0003,8:0.0004,7:0.0004,6:0.0004,5:0.0000,4.5:0.0000,4:0.0000}],
    [float_range(1.5,4.001,0.0001),{80:0.0000,72:0.0000,64:0.0000,56:0.0003,48:0.0003,44:0.0003,40:0.0003,36:0.0003,32:0.0004,28:0.0004,27:0.0004,24:0.0004,20:0.0004,18:0.0004,16:0.0004,14:0.0004,13:0.0004,12:0.0004,11.5:0.0004,11:0.0004,10:0.0004,9:0.0004,8:0.0005,7:0.0005,6:0.0005,5:0.0005,4.5:0.0005,4:0.0005}],
    [float_range(4,8,0.0001),{80:0.0000,72:0.0000,64:0.0000,56:0.0000,48:0.0000,44:0.0000,40:0.0000,36:0.0000,32:0.0005,28:0.0005,27:0.0005,24:0.0005,20:0.0005,18:0.0005,16:0.0006,14:0.0006,13:0.0006,12:0.0006,11.5:0.0006,11:0.0006,10:0.0006,9:0.0006,8:0.0006,7:0.0006,6:0.0006,5:0.0006,4.5:0.0006,4:0.0006}],
]

"""
from table 4.4 of ASME1721 - Minor Diamater tolerancs for Internal Threads
2nd element is from Table 3.1 of AS1014 under 0.75H column
3rd element is from Table 4.1 of AS1721 - Fundamental Deviations for G
"""

pitch_34p_fdforG_minord = [
        [{'pitch':0.2},(0.13),(17),{'4':38,'5':'','6':'','7':'','8':''}],
        [{'pitch':0.25},(0.162),(18),{'4':45,'5':56,'6':'','7':'','8':''}],
        [{'pitch':0.3},(0.195),(18),{'4':53,'5':67,'6':85,'7':'','8':''}],
        [{'pitch':0.35},(0.227),(19),{'4':63,'5':80,'6':100,'7':'','8':''}],
        [{'pitch':0.4},(0.26),(19),{'4':71,'5':90,'6':112,'7':'','8':''}],
        [{'pitch':0.45},(0.292),(20),{'4':80,'5':100,'6':125,'7':'','8':''}],
        [{'pitch':0.5},(0.325),(20),{'4':90,'5':112,'6':140,'7':180,'8':''}],
        [{'pitch':0.6},(0.39),(21),{'4':100,'5':125,'6':160,'7':200,'8':''}],
        [{'pitch':0.7},(0.455),(22),{'4':112,'5':140,'6':180,'7':224,'8':''}],
        [{'pitch':0.75},(0.487),(22),{'4':118,'5':150,'6':190,'7':236,'8':''}],
        [{'pitch':0.8},(0.52),(24),{'4':125,'5':160,'6':200,'7':250,'8':315}],
        [{'pitch':1},(0.65),(26),{'4':150,'5':190,'6':236,'7':300,'8':375}],
        [{'pitch':1.25},(0.812),(28),{'4':170,'5':212,'6':265,'7':335,'8':425}],
        [{'pitch':1.5},(0.974),(32),{'4':190,'5':236,'6':300,'7':375,'8':475}],
        [{'pitch':1.75},(1.137),(34),{'4':212,'5':265,'6':335,'7':425,'8':530}],
        [{'pitch':2},(1.3),(38),{'4':236,'5':300,'6':375,'7':475,'8':600}],
        [{'pitch':2.5},(1.624),(42),{'4':280,'5':355,'6':450,'7':560,'8':710}],
        [{'pitch':3},(1.95),(48),{'4':315,'5':400,'6':500,'7':630,'8':800}],
        [{'pitch':3.5},(2.273),(53),{'4':355,'5':450,'6':560,'7':710,'8':900}],
        [{'pitch':4},(2.598),(60),{'4':375,'5':475,'6':600,'7':750,'8':950}],
        [{'pitch':4.5},(2.923),(63),{'4':425,'5':530,'6':670,'7':850,'8':1060}],
        [{'pitch':5},(3.25),(71),{'4':450,'5':560,'6':710,'7':900,'8':1120}],
        [{'pitch':5.5},(3.572),(75),{'4':475,'5':600,'6':750,'7':950,'8':'1180'}],
        [{'pitch':6},(3.897),(80),{'4':500,'5':630,'6':800,'7':1000,'8':1250}],        
    ]


# To JS

@eel.expose    
def get_model(unit="metric"):
    if unit == "metric":
        # series = df.iloc[16:58, 1] #metric
        series = dfm.iloc[13:59, 1] #metric
    else:
        # series = df.iloc[89:119, 1] #imperial
        series = dfi.iloc[13:44, 1] #imperial
    items = [str(x).strip() for x in series.tolist() if pd.notna(x) and str(x).strip()]
    # print(items)
    return items

@eel.expose
def model_selected(model, unit):
    if unit == "metric":
        model = model
        x = model.index('X')
        major_diameter = int(model[1:x])
        dsh = model.index('-')
        pd = float(model[x + 1:dsh])
        tol = str(model[dsh + 1])
        gauge = model[len(model)-1:len(model)]
        pitch_lo = round(int(major_diameter) - (.6495*pd),3)
        
        # to get the tolerance
        # df.iloc[[0, 2], [1, 3]] selects the first and third rows, and the second and fourth columns).
        # tolerance_table = dfm.iloc[17:64,4:10]
        # print(tolerance_table)
        available = 0
        for i in tolerance_table:
            if major_diameter in i[0]:
                available = 1
                if pd in i:
                    if tol in i[2]:
                        tolerance = i[2].get(tol)
                        print(tolerance)

        # print(tolerance_table)
        # print(pitch_lo)
        # if gauge == "H":
            params: {
                'Tolerance': tolerance,
                'Pitch Lo': 1,
                'Pitch Hi': 1,
                'Major Lo': 1,
                'Major Hi': 2
            } # type: ignore
        #     print(major_diameter,x, dsh, pd, tol, gauge)
            print(tolerance)



    
    # return model



#end of to JS
if __name__ == "__main__":
    eel.start('index.html', size=(900, 600), position=(50,50))